<!DOCTYPE html>
<html>
<head>
    <title>Select Backend</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1 { color: #333; }
        form { margin: 20px 0; }
        select { padding: 8px; width: 300px; margin-right: 10px; }
        button { padding: 8px 16px; background-color: #0d6efd; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Select Backend for Frontend</h1>
    <form id="backendForm">
        <label for="backendSelect">Choose Backend:</label>
        <select id="backendSelect">
            <!-- Options will be populated dynamically -->
        </select>
        <button type="button" onclick="saveSelection()">Save Selection</button>
    </form>
    <p>Selected Backend: <span id="selectedBackend"></span></p>

    <script>
        async function loadBackends() {
            const response = await fetch('available-backends.txt');
            const backends = await response.text();
            const backendArray = backends.split('\n').filter(b => b.trim().length > 0);

            const select = document.getElementById("backendSelect");
            backendArray.forEach(backend => {
                const option = document.createElement("option");
                option.value = backend + ".eph.digitalzone-dev.net";
                option.textContent = backend;
                select.appendChild(option);
            });

            const storedBackend = localStorage.getItem("selectedBackend");
            if (storedBackend) {
                select.value = storedBackend;
                document.getElementById("selectedBackend").textContent = storedBackend;
            }
        }

        async function saveSelection() {
            const selectedBackend = document.getElementById("backendSelect").value;
            localStorage.setItem("selectedBackend", selectedBackend);
            document.getElementById("selectedBackend").textContent = selectedBackend;

            // Send selection to CircleCI via API (Trigger a new pipeline)
            const CIRCLECI_API_URL = "https://circleci.com/api/v2/project/gh/YahyaMohand/test-ephemeral/pipeline";
            const requestBody = {
                parameters: {
                    backend_service: selectedBackend
                }
            };

            try {
                const response = await fetch(CIRCLECI_API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Circle-Token": "CIRCLECI_TOKEN_2"  // CircleCI Token (Securely Passed from Env)
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    alert("Backend selection sent successfully to CircleCI!");
                } else {
                    alert("Error sending backend selection.");
                }
            } catch (error) {
                console.error("Upload error:", error);
                alert("Failed to send backend selection.");
            }
        }

        document.addEventListener("DOMContentLoaded", loadBackends);
    </script>
</body>
</html>
