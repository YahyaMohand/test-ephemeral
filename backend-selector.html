<!DOCTYPE html>
<html>
<head>
    <title>Select Backend</title>
    <script type="module">
        import { SSMClient, PutParameterCommand, GetParameterCommand } from "https://cdn.skypack.dev/@aws-sdk/client-ssm";

        // AWS Config (Credentials will be passed securely)
        const REGION = "me-south-1";  // Change to your AWS region
        const ssmClient = new SSMClient({ region: REGION });

        async function saveSelection() {
            const selectedBackend = document.getElementById("backendSelect").value;
            localStorage.setItem("selectedBackend", selectedBackend);
            document.getElementById("selectedBackend").textContent = selectedBackend;

            try {
                const command = new PutParameterCommand({
                    Name: "/selected-backend",
                    Value: selectedBackend,
                    Type: "SecureString",  // Use KMS for encryption
                    Overwrite: true
                });

                await ssmClient.send(command);
                alert("Backend saved successfully in AWS SSM (KMS encrypted).");

            } catch (error) {
                console.error("Error saving to SSM:", error);
                alert("Failed to save backend.");
            }
        }

        async function loadBackends() {
            try {
                const response = await fetch('available-backends.txt');
                const backends = await response.text();
                const backendArray = backends.split('\n').filter(b => b.trim().length > 0);

                const select = document.getElementById("backendSelect");
                backendArray.forEach(backend => {
                    const option = document.createElement("option");
                    option.value = backend + ".eph.digitalzone-dev.net";
                    option.textContent = backend;
                    select.appendChild(option);
                });

                // Retrieve stored backend
                const command = new GetParameterCommand({ Name: "/selected-backend", WithDecryption: true });
                const result = await ssmClient.send(command);
                const storedBackend = result.Parameter.Value;

                if (storedBackend) {
                    select.value = storedBackend;
                    document.getElementById("selectedBackend").textContent = storedBackend;
                }
            } catch (error) {
                console.warn("No stored backend found.");
            }
        }

        document.addEventListener("DOMContentLoaded", loadBackends);
        window.saveSelection = saveSelection;  // Ensure function is accessible in HTML onclick
    </script>
</head>
<body>
    <h1>Select Backend</h1>
    <form id="backendForm">
        <label for="backendSelect">Choose Backend:</label>
        <select id="backendSelect"></select>
        <button type="button" onclick="saveSelection()">Save Selection</button>
    </form>
    <p>Selected Backend: <span id="selectedBackend"></span></p>
</body>
</html>
